# Install: `cargo install cargo-make`
# Help: https://sagiegurari.github.io/cargo-make/

[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true

[config]
default_to_workspace = true
skip_core_tasks = true
skip_crate_env_info = true
skip_git_env_info = true
skip_rust_env_info = true

# -------------------------------------
# CI Checks
# -------------------------------------
[tasks.check]
dependencies = ["audit", "fmt", "lint", "outdated", "deps"]

[tasks.ci]
dependencies = ["lint", "test", "test-doc", "vet", "outdated", "deny", "fmt"]

# -------------------------------------
# Individual Actions
# -------------------------------------

# Audit
[tasks.audit]
command = "cargo"
args = ["audit"]

# Clean
[tasks.clean]
command = "cargo"
args = ["clean"]

# Deny
[tasks.deny]
command = "cargo"
args = ["deny", "--workspace", "check"]
install_crate = "cargo-deny"

# Deps
[tasks.deps]
script = '''
cargo +nightly udeps --all-targets
'''
install_crate = "cargo-udeps"
# args = ["machete", "--skip-target-dir"]
# install_crate = "cargo-machete"

# Fmt
[tasks.fmt]
script = "cargo +nightly fmt --all"

# Lint
[tasks.lint]
command = "cargo"
args = ["clippy", "--all-features"]
install_crate = { rustup_component_name = "clippy" }

# Miri
[tasks.miri]
script = '''
cargo +nightly miri setup
cargo +nightly miri nextest run --no-tests=pass
'''

# Outdated
[tasks.outdated]
script = '''
cargo outdated --workspace --exit-code 1 --depth 1
'''
install_crate = "cargo-outdated"

# Test
[tasks.test]
command = "cargo"
args = ["nextest", "run", "--all", "--all-features", "--no-tests=pass"]
dependencies = ["clean"]
env = { RUSTFLAGS = "-Dwarnings" }

# Test Doc
[tasks.test-docs]
command = "cargo"
args = ["test", "--doc", "--all-features", "--workspace"]

# Vet
[tasks.vet]
script = '''
cargo vet regenerate imports
cargo vet regenerate exemptions
cargo vet regenerate unpublished
cargo vet --locked
'''
install_crate = "cargo-vet"

[tasks.publish]
command = "cargo"
args = ["publish", "--registry=augentic", "--allow-dirty", "--dry-run"]

# Publish all crates to crates.io in dependency order (dry-run by default).
# Remove --dry-run to actually publish.
[tasks.publish-crates-io]
script = '''
set -e

DRY_RUN="--dry-run"
if [ "${PUBLISH_FOR_REAL}" = "true" ]; then
  DRY_RUN=""
fi

echo "=== Tier 1: No internal dependencies ==="
cargo publish -p omnia-guest-macro $DRY_RUN
cargo publish -p omnia-runtime-macro $DRY_RUN
cargo publish -p omnia-wasi-otel-attr $DRY_RUN
cargo publish -p omnia-otel $DRY_RUN

echo "=== Tier 2: Core runtime ==="
cargo publish -p omnia $DRY_RUN

echo "=== Tier 3: WASI interface crates ==="
cargo publish -p omnia-wasi-blobstore $DRY_RUN
cargo publish -p omnia-wasi-config $DRY_RUN
cargo publish -p omnia-wasi-http $DRY_RUN
cargo publish -p omnia-wasi-identity $DRY_RUN
cargo publish -p omnia-wasi-keyvalue $DRY_RUN
cargo publish -p omnia-wasi-messaging $DRY_RUN
cargo publish -p omnia-wasi-sql $DRY_RUN
cargo publish -p omnia-wasi-vault $DRY_RUN
cargo publish -p omnia-wasi-websocket $DRY_RUN
cargo publish -p omnia-wasi-otel $DRY_RUN

echo "=== Tier 4: ORM ==="
cargo publish -p omnia-orm $DRY_RUN

echo "=== Tier 5: SDK ==="
cargo publish -p omnia-sdk $DRY_RUN

echo "=== Done ==="
'''
